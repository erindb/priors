---
title: "What does the crowd believe?"
subtitle: "A hierarchical approach to estimating subjective beliefs"
author: "Michael Franke, Fabian Dablander, Anthea Schöller (Tübingen)"
date : "Erin Bennett, Judith Degen, Michael Henry Tessler, Justine Kao & Noah D. Goodman (Stanford)"
runtime: shiny
output:
  ioslides_presentation:
    css: mistyle.css
    smaller: yes
    transition: faster
---
```{r setup, include=FALSE, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, dev.args = list(bg = 'transparent'), fig.align='center')
require('ggplot2')
require('reshape2')
require('coda')
require('ggmcmc')
require('rjags')
require('runjags')
require('dplyr')
require('gridExtra')
require('rstan')
theme_set(theme_bw() + theme(plot.background=element_blank()) )
```

## overview

<span style = "color:firebrick">recap</span>

- 3 types of Bayesianism:
    - Bayesian versions of classical statistical tests
    - Bayesian modeling of data-generating process
    - cognitive models that assume that people "are Bayesian"

<span style = "color:white"> dummy </span>

<span style = "color:firebrick">today</span>

- subjective beliefs for models of "Bayesian cognition"

## what, where from, where to?

<span style = "color:firebrick">the "priors consortium"</span>

<div style = "float:left; width:45%;">
  
  - Erin D. Bennett
  - Fabian Dablander
  - Judith Degen
  - Michael Franke
  - Noah Goodman
  
</div>

<div style = "float:right; width:45%;">
  
  - Justine Kao
  - Anthea Schoeller
  - Michael Henry Tessler
  - Ciyang Qing
  - ... ??? ...
  
</div>  

<span style = "color:white"> dummy </span>

<span style = "color:white"> dummy </span>

<p>

<div>
<span style = "color:firebrick">disclaimer</span>

- this is mess in progress
- all follies are mine

</div>

# background

## "Bayesian cognition"

<span style = "color:firebrick">Bayes for learning</span>

- prior beliefs on what "structure" can be expected
    - (possibly innate) learning biases
- Bayes rule to learn from sparse input
    - language acquisition 
    - conceptualization, generalization

<span style = "color:firebrick">Bayes for performance</span>

- model task behavior as (partly) Bayesian inference
    - rationalistic explanation, not necessarily mechanism/process
- subject's beliefs about everyday events (task items) plays a role
    - reasoning from premisses, future predictions, etc.
    - language use and interpretation
        - vagueness, non-literal interpretation etc.
        
## example: vague <span style = "font-style: italic">many</span>

<span style = "color:firebrick">sentence</span>

Joe eats many burgers.

<span style = "color:firebrick">cardinal surprise reading</span>

Joe eats more bugers that we would expect of him.

<span style = "color:firebrick">theory</span>

- look at expectation $p$ about burger consumption for the "kind of guy" that Joe is
    - $p(n)$ is the probability that a guy like Joe eats $n$ burgers
    - let $P$ be the cumulative distribution of $p$
- let $b$ be the number of burgers that Joe actually eats
- "Joe eats many burgers" is true iff $P(b)$ is bigger than a fixed threshold
    - that threshold is the same for all sentences of this kind
    - contextual vagueness from uncertainty about $p$

<div style = "position:absolute; top: 620px; right:60px; color:darkblue;">
  (e.g., Schoeller & Franke 2015)
</div>

## enter subjective beliefs

<span style = "color:firebrick">desideratum</span>

- compact, versatile respresentation of subjective beliefs
- non-expert beliefs about possibly mundane affairs
- cheap, fast and reliable ways of assessment

<span style = "color:firebrick">previous literature</span>

- take real-world frequencies as stand-in for subjective beliefs
- measure beliefs experimentally, e.g.:
    - infer parameters of Gaussian from a judgements of cumulative probability (Manski, 2004)
    - infer parameters and type of distribution from predictions (Tauber & Steyvers 2013)
    - binned slider ratings (Kao et al., 2014)

## binned slider ratings

<div align = 'center'>
  <img src="pics/VQ_prior_elicitation_screen.png" alt="manyPriors" style="width: 800px;"/>
</div>

- discretize domain into bins; let subjects rate each bin
- take relative measure: normalize slider ratings per participant
- average (normalized) slider rating to reflect population-level belief
    - "wisdom of the crowds"

<div style = "position:absolute; top: 620px; right:60px; color:darkblue;">
  (e.g., Schoeller & Franke 2015)
</div>


## agenda

<span style = "color:firebrick">issues</span>

- wanted: reliable & practical way of measuring beliefs
    - consistency across measures
- relation subjects' answers, their beliefs and the population-level aggregate?
    - what of between-subject variance in task data?

<span style = "color:white"> dummy </span>

<span style = "color:firebrick">approach</span>

- belief elicitation with different tasks (within-subject)
- Bayesian hierarchical model to infer latent subjective & "population-level beliefs"
    - "population-level belief" => central tendency of subjective beliefs
    - think: "mean of a Gaussian hyperprior"



# experiments

## overview

- 20 participants recruited via MTurk
- each saw every condition of every task
- 8 items (from previous research)
- 3 task types:
    - slider ratings
    - number estimates
    - binary comparison (a.k.a. "lightning round")

## items

<div style = "position:absolute; top: 110px; left:50px;">

1. "X has just fetched himself a cup of <span style = "color:firebrick">coffee</span> from the office vending machine."
    - "What do you think the temperature of his coffee is?"  
    
2. "X <span style = "color:firebrick">commuted</span> to work yesterday."  
    - "How many minutes do you think she spent commuting yesterday?"
    
3. "X told a <span style = "color:firebrick">joke</span> to N kids."   
    - "How many of the kids do you think laughed?"
    
4. "X bought a <span style = "color:firebrick">laptop</span>."         
    - "How much do you think it cost?"
    
5. "X threw N <span style = "color:firebrick">marbles</span> into a pool."
    - "How many of the marbles do you think sank?"

6. "X just went to the <span style = "color:firebrick">movies</span> to see a blockbuster."
    - "How many minutes long do you think the movie was?"

7. "X watched <span style = "color:firebrick">TV</span> last week."
    - "How many hours do you think he spent watching TV last week?"

8. "X bought a <span style = "color:firebrick">watch</span>."
    - "How much do you think it cost?"
                                        
</div>
    

## slider ratings

<span style = "color:white"> dummy </span>


<div align = 'center'>
  <img src="pics/priors_sliders.png" alt="priorsslider" style="width: 600px;"/>
</div>

## number estimates 

<span style = "color:white"> dummy </span>

<div align = 'center'>
  <img src="pics/priors_numbers.png" alt="priorsnumbers" style="width: 600px;"/>
</div>

## binary choices 

<span style = "color:white"> dummy </span>

<div align = 'center'>
  <img src="pics/priors_lightning.png" alt="priorslightning" style="width: 600px;"/>
</div>

# results

## slider ratings

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/data_slider.png" alt="dataslider" style="width: 600px;"/>
</div>

## number estimates

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/data_number.png" alt="dataslider" style="width: 600px;"/>
</div>

## lightning round

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/data_choice.png" alt="dataslider" style="width: 600px;"/>
</div>

# model

## questions

<span style = "color:firebrick">general</span>

- is there a consistent population-level average that explains participants choices?
- is the average slider rating a good approximation of a latent population-level average?
- how much individual variance is there?

<span style = "color:white"> dummy </span>

<span style = "color:firebrick">specific (technical)</span>

- hierarchical group-level prior for subjective beliefs?
- link functions for task types?

## slider data

$s_{ijk} \in [0;1]$ - normalized slider ratings of subject $i$ for item $j$ and bin $k$


```{r, echo = FALSE}
source('//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/process_data.R')
# bin_dat <- 
# choice_dat <- read.csv('//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/data/choice_dat.csv')
# number_dat <- read.csv('//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/data/number_dat.csv')
# 
# 
# ## slider rating data
# y.slider = array(0, dim = c(20,8,15))
# for (i in 1:nrow(bin_dat)){
#   y.slider[bin_dat$workerid[i] + 1, 
#            as.numeric(bin_dat$tag)[i],
#            bin_dat$bin_num[i]] = bin_dat$nresponse[i]
# }
# # y.slider = logit(add.margin(y.slider))
# 
# # number choice data
# y.number = array(0, dim = c(20,8,1))
# for (i in 1:nrow(number_dat)){
#   y.number[number_dat$workerid[i] + 1, 
#            as.numeric(number_dat$tag)[i],
#            1] = number_dat$chosen_bin[i]
# }
# y.number = y.number[,,1]
# 
# ## lightning round choice data
# choice_dat = choice_dat %>% mutate(condition = factor(ifelse(chosen_bin > unchosen_bin, unchosen_bin, chosen_bin)))
# choice_dat$condition = as.numeric(choice_dat$condition)
# y.choice = array(0, dim = c(20,8,5))
# higher   = array(0, dim = c(20,8,5))
# lower    = array(0, dim = c(20,8,5))
# for (i in 1:nrow(choice_dat)){
#   y.choice[choice_dat$workerid[i] + 1, 
#            as.numeric(choice_dat$tag)[i],
#            choice_dat$condition[i]] = ifelse(choice_dat$higher_chosen[i] , 1, 0)
# }
```


```{r}
dim(y.slider)
y.slider[1,1:4,1:5]
```

## number data

$n_{ij} \in \{1, \dots, 15\}$ - number of bin for number choice of subject $i$ and item $j$   

```{r}
y.number[1:12,,]
```

## lightning choice data

$c_{ijl} \in \{ 0, 1\}$ - whether subject $i$ chose the higher bin in lightning round $l \in \{ 1, \dots, 5\}$ for item $j$

```{r}
y.choice[1,,]
```


## model

<div style = "position:absolute; top: 100px; left:100px;">
  <img src="//Users/micha/Desktop/data/svn/priors/text/01_CogSci_abstract/modelGraph/modelGraph.png" alt="modelGraph" style="width: 700px;"/>
</div>

## hierarchical population prior

- $w \sim \text{Gamma}(2,0.1)$
- $Q_{j}  \sim \text{Dirichlet}(1,\dots, 1)$
- $P_{ij} \sim \text{Dirichlet}(w Q_j)$

<span style = "color:white"> dummy </span>


<div style = "float:left; width:45%;">
`w = 20`
```{r, echo = FALSE, fig.align='center', fig.width=4, fig.height=3}
library('gtools')
p = c(0, 1, 1.4, 2, 4, 4.2, 4.1, 3.7, 4, 3.1, 2, 1.6, 0.8, 0.2)
p = p/sum(p)
ggplot(melt(rdirichlet(alpha= p*20, n = 10)), aes(x = Var2, y = value, fill = factor(Var1), color = "gray")) + geom_line(color = "gray") + geom_line(data = cbind(melt(p), x=1:14, Var1 = "a"), aes(x = x, y = value, color = "red")) + theme(legend.position="none") + xlab("") + ylab("")
```  
</div>
<div style = "float:right; width:45%;">
`w = 200`
```{r, echo = FALSE, fig.align='center', fig.width=4, fig.height=3}
ggplot(melt(rdirichlet(alpha= p*200, n = 10)), aes(x = Var2, y = value, fill = factor(Var1), color = "gray")) + geom_line(color = "gray") + geom_line(data = cbind(melt(p), x=1:14, Var1 = "a"), aes(x = x, y = value, color = "red")) + theme(legend.position="none") + xlab("") + ylab("")
```  
</div>  



## link function: sliders

- $\kappa \sim \text{Gamma}(5,5)$
- $\sigma \sim \text{Gamma}(0.0001, 0.0001)$
- $s_{ijk} \sim  \text{logistic}(\text{Norm}(\text{logit}(P_{ijk}), \sigma), \kappa)$

```{r, echo = FALSE}
library(ggplot2)
library(reshape2)

# sequence of subjective probabilities for a given bin and item
pijks = seq(0.0000001,.9999999, length.out = 101) 

logit = function(x, k = 1){
  k * log(x / (1-x))
} 

logistic = function(x, k = 1, zero = 0) {
  # k is steepness of the curve
  return(1 / (1 + exp(-1/k*(x - zero))))
}

sd = 0.5 # global Gaussian noise
k = 1 # global steepness of logistic transform (has to be 1 in JAGS)
kLogit = 1.2 # global steepness of logit transform
        # (kLogit > k : end-point averse, kLogit < k: end-point loving )


noiseIV = function(x, sd = 0.25, percentile = .25){
  # get percentiles to see how much noise affects choices
  # per default we get the 95% CI about where noise-perturbations would lie
  return(sapply(x, function(y) qnorm(p = c(percentile, 1- percentile), mean = y, sd = sd)))
}

uplow = noiseIV(logit(pijks, kLogit), sd = sd)

plotData = data.frame(p = pijks,
                      lower = logistic(uplow[1,],k),
                      upper = logistic(uplow[2,],k),
                      mean = logistic(logit(pijks, kLogit),k))
plotDataMelted = melt(plotData, id.vars = c("p"))

myPlot = ggplot(plotDataMelted, aes(x = p, y = value, color = variable)) + geom_line() + xlab("P_ijk") + ylab("probability of S_ijk")


sd = 1.5 # global Gaussian noise
k = 1 # global steepness of logistic transform (has to be 1 in JAGS)
kLogit = 2 # global steepness of logit transform
        # (kLogit > k : end-point averse, kLogit < k: end-point loving )


noiseIV = function(x, sd = 0.25, percentile = .25){
  # get percentiles to see how much noise affects choices
  # per default we get the 95% CI about where noise-perturbations would lie
  return(sapply(x, function(y) qnorm(p = c(percentile, 1- percentile), mean = y, sd = sd)))
}

uplow = noiseIV(logit(pijks, kLogit), sd = sd)

plotData = data.frame(p = pijks,
                      lower = logistic(uplow[1,],k),
                      upper = logistic(uplow[2,],k),
                      mean = logistic(logit(pijks, kLogit),k))
plotDataMelted = melt(plotData, id.vars = c("p"))

myPlot2 = ggplot(plotDataMelted, aes(x = p, y = value, color = variable)) + geom_line() + xlab("P_ijk") + ylab("probability of S_ijk")

```

<span style = "color:white"> dummy </span>

<div style = "float:left; width:45%;">
`kappa = 1.2, sigma = 0.5`
```{r, echo = FALSE, fig.align='center', fig.width=4, fig.height=3}
show(myPlot)
```  
</div>
<div style = "float:right; width:45%;">
`kappa = 2, sigma = 1.5`
```{r, echo = FALSE, fig.align='center', fig.width=4, fig.height=3}
show(myPlot2)
```  
</div>  

## link function: numbers

- $a \sim \text{Gamma}(2,1)$
- $n_{ij} \sim \text{Categorical}(\text{exp}(a P_{ij}))$

<span style = "color:white"> dummy </span>

```{r, echo = TRUE, eval = FALSE}
qplot(sample(x = 5, size = 1000, replace = TRUE, prob = exp(a *(1:5))))
```

<div style = "float:left; width:45%;">
`a = 0.5`
```{r, echo = FALSE, fig.align='center', fig.width=4, fig.height=3}
qplot(sample(x = 5, size = 1000, replace = TRUE, 
             prob = exp(0.5 *(1:5)))) + 
  xlab("choice") + ylab("frequency")
```
</div>
<div style = "float:right; width:45%;">
`a = 1.5`
```{r, echo = FALSE,fig.align='center', fig.width=4, fig.height=3}
qplot(sample(x = 5, size = 1000, replace = TRUE, 
             prob = exp(1.5 *(1:5)))) + 
  xlab("choice") + ylab("frequency")
```  
</div>  

## link function: lightning

- $b \sim \text{Gamma}(2,1)$
- $c_{ijl} \sim \text{Bern}(\text{exp}(b \ (p^{\text{high}}_{ijl}, p^{\text{low}}_{ijl}))$

$$p^\text{high}_{ijl} = \begin{cases} 2 & \text{if $mode(P_{ij})$ is closer to higher} \\
& \text{ bin of $l$ than to lower bin }  \\ 1 & \text{if equal
            distance} \\ 0 & \text{otherwise}  \end{cases}$$

$$p^\text{low}_{ijl} = 2 - p^\text{high}_{ijk}$$

<span style = "color:firebrick">example</span>

- what's more likely: John scored 10-12, or John scored 26-28 points?
- subjective belief says: most likely John scored 14-16
- lower bin is closer, so 

## model

<div style = "position:absolute; top: 100px; left:100px;">
  <img src="//Users/micha/Desktop/data/svn/priors/text/01_CogSci_abstract/modelGraph/modelGraph.png" alt="modelGraph" style="width: 700px;"/>
</div>

# Bayesian inference

## set-up

- implemented in JAGS
- 50,000 samples after a burn in of 100,000
- convergence checks: visually and $\hat{R}$

## posterior over parameters

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/posterior_parameters.png" alt="postParameters" style="width: 650px;"/>
</div>

## population-level beliefs $Q_j$

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/pop_priors.png" alt="postPriors" style="width: 580px;"/>
</div>

<div style = "position:absolute; top: 620px; right:60px; color:darkblue;">
  red: averaged normal. slider ratings; black: mean posterior $Q_i$ with 95% HDIs
</div>

## individual vs. population-level beliefs

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/pop_priorsSubj.png" alt="postSubjPriors" style="width: 580px;"/>
</div>

<div style = "position:absolute; top: 620px; right:60px; color:darkblue;">
  black: mean posterior $Q_j$ with 95% HDIs; dark gray: mean posterior $P_{ij}$
</div>

## impressions

<span style = "color:firebrick">from visual inspection</span>

- subjective beliefs differ from population-level mean (good!)
- avrgd normlzd slider ratings nicely approximate mean $Q_j$ (excellent!)

# model criticism

## PPC averaged normalized slider

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/ppc_slider.png" alt="ppcSlider" style="width: 560px;"/>
</div>

avrgd normlzd slider ratings we would expect from the model and the posterior distribution over parameters is virtually indistinguishable from the observed


## PPC number choice

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/ppc_number.png" alt="ppcNumber" style="width: 560px;"/>
</div>

some frequencies of number choices are suprising for the trained model (but: little data to go with; round or salient numbers may play a role)

## PPC lightning round

<div align = 'center'>
  <img src="//Users/micha/Desktop/data/svn/priors/models/04_Exp2_Manski_JAGS/plots/ppc_choice.png" alt="ppcChoice" style="width: 560px;"/>
</div>

miserable failure to predict why it should be more likely that no marble sank than that one marble sank (alternative explanation: subjects revise beliefs, assume homogeneous "wonkiness" of marbles)

## to do

- posterior predictive checks for individual-level $P_{ij}$

- posterior predictive <span style = "font-style: italic">p</span>-value with test statistics:
    - entropy of normalized slider ratings per subject
    - mean of normalized slider ratings per subject
    
# conclusions

## conclusions

<span style = "color:white"> dummy </span>

- avrgd normlzd slider ratings appear to be practical and reliable measures 

<span style = "color:white"> dummy </span>

- slider ratings closely track pop-level central tendency of individual beliefs

<span style = "color:white"> dummy </span>

- hierarchical modeling of population-level beliefs is possible

<span style = "color:white"> dummy </span>

- link functions for task choices seem reliable (enough)