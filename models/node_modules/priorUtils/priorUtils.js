var fs = require('fs');
var babyparse = require('babyparse');

var erpWriter = function(erp, filename) {
 var supp = erp.support([]);
 var csvFile = fs.openSync(filename, 'w');
 fs.writeSync(csvFile,'Parameter,Item,Prevalence,Value,Probability\n')
 supp.forEach(function(s) {supportWriter(s, Math.exp(erp.score([], s)), csvFile);})
 fs.closeSync(csvFile);
}

var supportWriter = function(s, p, handle) {
 var sLst = _.pairs(s);
 var l = sLst.length;

 for (var i = 0; i < l; i++) {
   fs.writeSync(handle, sLst[i].join(',')+','+p+'\n');
 }
}

function readCSV(filename){
  return babyparse.parse(fs.readFileSync(filename, 'utf8')).data;
};

function wpParseFloat(x){
  return parseFloat(x);
};

function mySort(lst, field){
	return lst.sort(function(a, b) {
	    return a[field]-b[field];
	})
};

function getOrderedBinData(data){
	return _.pluck(mySort(data, "bin_num"), "nresponse")
}

module.exports = {
  readCSV: readCSV,
  wpParseFloat: wpParseFloat,
  erpWriter:erpWriter,
  getOrderedBinData:getOrderedBinData
};
